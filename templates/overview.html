<script>
// Handle auto-logout for expired sessions
document.addEventListener('DOMContentLoaded', function() {
    // Check authentication status on API calls
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        return originalFetch.apply(this, args)
            .then(response => {
                if (response.status === 401) {
                    return response.json().then(data => {
                        if (data.auto_logout) {
                            // Session expired - redirect to login
                            window.location.href = '/';
                        }
                        throw new Error(data.error || 'Authentication required');
                    });
                }
                return response;
            });
    };
});
</script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overview - GoodDollar Analytics</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GoodMarket">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #1f2937;
            overflow-x: hidden;
            position: relative;
        }



        /* Animated background particles */
        .bg-particles {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            display: none;
        }

        .particle::before {
            content: 'üí∞';
        }

        .particle:nth-child(2)::before {
            content: 'üíé';
        }

        .particle:nth-child(3)::before {
            content: '‚≠ê';
        }

        .particle:nth-child(5)::before {
            content: '‚ú®';
        }

        .particle:nth-child(7)::before {
            content: 'üåü';
        }



        .navbar {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #7c3aed;
            text-decoration: none;
            letter-spacing: -0.5px;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: #6b7280;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 1rem;
        }

        .nav-links a:hover {
            color: #7c3aed;
        }

        .nav-links a.active {
            color: #1f2937;
        }

        .wallet-info {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            font-family: monospace;
            font-size: 0.95rem;
            color: #1f2937;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            position: relative;
            z-index: 10;
        }

        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: #1f2937;
            letter-spacing: -1px;
        }

        .page-subtitle {
            color: #6b7280;
            font-size: 1.1rem;
            font-weight: 400;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .analytics-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            padding: 2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .analytics-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(124, 58, 237, 0.1);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .stat-value {
            color: #1f2937;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: -0.5px;
        }

        .insight-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .insight-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(124, 58, 237, 0.1);
        }

        .insight-header {
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .country-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .country-tag {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transition: width 0.3s ease;
        }

        .refresh-btn {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
            box-shadow: 0 4px 6px rgba(124, 58, 237, 0.2);
        }

        .refresh-btn:hover {
            background: #6d28d9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(124, 58, 237, 0.3);
        }

        .dashboard-btn {
            display: inline-block;
            background: #7c3aed;
            color: white;
            text-decoration: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(124, 58, 237, 0.2);
        }

        .dashboard-btn:hover {
            background: #6d28d9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(124, 58, 237, 0.3);
            color: white;
        }

        /* 12-Hour Bonus Styles */

        .cooldown-display {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .cooldown-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }


        /* Success Animation Styles */
        .success-animation {
            position: relative;
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            border-radius: 15px;
            overflow: hidden;
        }

        .success-message h4 {
            color: #155724;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .success-message p {
            color: #155724;
            font-size: 1.1em;
            margin: 0;
        }

        .emoji-shower {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .emoji {
            position: absolute;
            font-size: 2em;
            animation: emojiFloat 3s ease-out forwards;
            opacity: 0;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .emoji.animate {
            opacity: 1;
        }

        @keyframes emojiFloat {
            0% {
                transform: translateX(-50%) translateY(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            50% {
                transform: translateX(-50%) translateY(-150px) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(-300px) rotate(360deg);
                opacity: 0;
            }
        }

        .emoji:nth-child(1) { animation-delay: 0.2s; }
        .emoji:nth-child(2) { animation-delay: 0.4s; }
        .emoji:nth-child(3) { animation-delay: 0.6s; }
        .emoji:nth-child(4) { animation-delay: 0.8s; }
        .emoji:nth-child(5) { animation-delay: 1.0s; }

        /* New Styles for Action Buttons */
        .action-btn {
            background: linear-gradient(135deg, #667eea, #764ba2, #4facfe, #00f2fe);
            background-size: 300% 300%;
            animation: gradientShift 4s ease infinite;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
            text-decoration: none;
            display: inline-block;
            margin: 8px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            position: relative;
            overflow: hidden;
            box-shadow:
                0 8px 25px rgba(79, 172, 254, 0.4),
                0 4px 15px rgba(118, 75, 162, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.6s ease;
        }

        .action-btn:hover::before {
            transform: scale(1);
        }

        .action-btn:hover {
            color: white;
        }

        .action-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .action-btn:disabled {
            background: linear-gradient(135deg, #6c757d, #495057);
            cursor: not-allowed;
            opacity: 0.7;
            animation: none;
            position: relative;
            overflow: hidden;
        }

        .action-btn:disabled::after {
            content: 'üîí';
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .action-btn:disabled:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            background-size: 300% 300%;
        }



        @media (max-width: 768px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .nav-links {
                flex-direction: column;
                gap: 15px;
            }

            .page-title {
                font-size: 2rem;
            }
        }

        .btn-loader {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .cta-button {
            position: relative;
            transition: all 0.3s ease;
        }

        .cta-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .cta-button.processing {
            pointer-events: none;
        }

        .btn-content {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-content .cta-icon {
            transition: transform 0.3s ease;
        }

        .cta-button:hover:not(:disabled) .btn-content .cta-icon {
            transform: scale(1.1);
        }

        /* Styles for notification badge */
        .notification-badge {
            background-color: #f87171; /* Red color */
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 0.8rem;
            font-weight: bold;
            position: absolute;
            top: -5px; /* Adjust position as needed */
            right: -5px; /* Adjust position as needed */
            min-width: 20px; /* Ensure minimum width */
            text-align: center;
            display: none; /* Hidden by default */
        }

        /* Styles for notification messages */
        .notification-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #e6f7ff;
            color: #005080;
            border: 1px solid #91d5ff;
            border-radius: 8px;
            padding: 12px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            animation: fadeInOut 5s forwards;
            display: none; /* Hidden by default */
        }

        .notification-message.info {
            background-color: #e6f7ff;
            border-color: #91d5ff;
        }

        .notification-message.success {
            background-color: #f6ffed;
            border-color: #b7eb8f;
            color: #389e0d;
        }

        .notification-message.warning {
            background-color: #fffbe6;
            border-color: #ffe58f;
            color: #d48806;
        }

        .notification-message.error {
            background-color: #fff1f0;
            border-color: #ffa39e;
            color: #cf1322;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .feature-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            text-decoration: none;
            color: #1f2937;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(124, 58, 237, 0.1);
        }

        .card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .feature-card h3 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .feature-card p {
            font-size: 0.9rem;
            color: #6b7280;
        }
        </style>
</head>
<body>
    <!-- Animated Background Particles -->
    <div class="bg-particles">
        <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
        <div class="particle" style="left: 20%; animation-delay: 2s;"></div>
        <div class="particle" style="left: 30%; animation-delay: 4s;"></div>
        <div class="particle" style="left: 40%; animation-delay: 1s;"></div>
        <div class="particle" style="left: 50%; animation-delay: 3s;"></div>
        <div class="particle" style="left: 60%; animation-delay: 5s;"></div>
        <div class="particle" style="left: 70%; animation-delay: 2.5s;"></div>
        <div class="particle" style="left: 80%; animation-delay: 4.5s;"></div>
        <div class="particle" style="left: 90%; animation-delay: 1.5s;"></div>
    </div>

    <nav class="navbar">
        <div class="nav-container">
            <a href="/dashboard" class="logo">üí∞ GoodDollar</a>
            <div class="nav-links">
                <a href="/overview" style="color: white; font-weight: 700;">Overview</a>
                {% if wallet and wallet != 'None' %}
                <a href="/dashboard">Dashboard</a>
                <a href="/admin" id="adminLink" style="display: none;">Admin</a>
                <a href="/logout">Logout</a>
                <div class="wallet-info">
                    {{ wallet[:6] }}...{{ wallet[-4:] }}
                </div>
                {% else %}
                <a href="/" class="action-btn" style="padding: 0.5rem 1.5rem; margin: 0;">Login</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">üìä Analytics Overview</h1>
            <p class="page-subtitle">Comprehensive insights into your GoodDollar activity and global network</p>
            <a href="/dashboard" class="action-btn" id="dashboardBtn" onclick="showDashboardLoading(event)">
                üöÄ Enter Web3 Dashboard
            </a>
        </div>

        <div class="analytics-grid">
            <!-- Personal Analytics -->
            {% if wallet and wallet != 'None' %}
            <div class="analytics-card">
                <div class="card-title">üë§ Your Activity</div>
                <div class="stat-row">
                    <div class="stat-label">Page Views</div>
                    <div class="stat-value">{{ data.user_stats.page_views }}</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Learn & Earn Quizzes</div>
                    <div class="stat-value">{{ data.user_stats.learn_earn_quizzes }}</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">24-Hour Bonus Claims</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Telegram Task Claims</div>
                    <div class="stat-value">{{ data.user_stats.telegram_task_claims }}</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Total G$ Earned</div>
                    <div class="stat-value">{{ data.user_stats.total_rewards_earned }}</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Member Since</div>
                    <div class="stat-value">{{ data.user_stats.member_since }}</div>
                </div>
            </div>
            {% else %}
            <div class="analytics-card" style="background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(99, 102, 241, 0.1)); border: 2px solid rgba(124, 58, 237, 0.3);">
                <div class="card-title">üîê Login to View Your Activity</div>
                <div style="text-align: center; padding: 2rem 1rem;">
                    <p style="color: #6b7280; margin-bottom: 1.5rem;">Login to track your personal statistics and earnings</p>
                    <a href="/" class="action-btn">Login Now</a>
                </div>
            </div>
            {% endif %}

            <!-- Platform Statistics -->
            <div class="analytics-card">
                <div class="card-title">üåê Platform Statistics</div>
                <div class="stat-row">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value">{{ data.platform_stats.metrics.total_users }}</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Learn & Earn Users</div>
                    <div class="stat-value">{{ data.platform_stats.metrics.learn_earn_users }}</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Telegram Task Users</div>
                    <div class="stat-value">{{ data.platform_stats.metrics.telegram_task_users }}</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Global UBI Users</div>
                    <div class="stat-value">{{ data.gooddollar_info.estimated_users }}</div>
                </div>
            </div>

            <!-- Contract Balance -->
            <div class="analytics-card">
                <div class="card-title">üí∞ Contract Balance</div>
                {% if wallet and wallet != 'None' %}
                <div class="stat-row">
                    <div class="stat-label">Your G$ Balance</div>
                    <div class="stat-value" id="user-balance">Loading...</div>
                </div>
                {% else %}
                <div class="stat-row">
                    <div class="stat-label">Your G$ Balance</div>
                    <div class="stat-value">Login to view</div>
                </div>
                {% endif %}
                <div class="stat-row">
                    <div class="stat-label">Contract Address</div>
                    <div class="stat-value" style="font-size: 0.9rem;" id="contract-address">Loading...</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Network</div>
                    <div class="stat-value">Celo Mainnet</div>
                </div>
            </div>
        </div>

        <!-- Total G$ Disbursements Breakdown -->
        <div class="insight-card">
            <div class="insight-header">üí∞ Total G$ Disbursements Breakdown</div>
            <div class="stat-row">
                <div class="stat-label">Total Disbursed</div>
                <div class="stat-value" style="color: #4facfe; font-size: 1.5rem;">
                    {{ data.disbursement_analytics.total_g_disbursed_formatted if data.disbursement_analytics else '0 G$' }}
                </div>
            </div>

            {% if data.disbursement_analytics and data.disbursement_analytics.breakdown_formatted %}
                <div style="margin-top: 1.5rem;">
                    <div style="font-size: 0.95rem; font-weight: 600; margin-bottom: 1rem; color: rgba(241, 245, 249, 0.9);">
                        Platform Features Distribution:
                    </div>

                    {% for category, amount in data.disbursement_analytics.breakdown_formatted.items() %}
                    <div class="stat-row" style="padding: 10px 0; border-bottom: 1px solid rgba(99, 102, 241, 0.1);">
                        <div class="stat-label" style="font-size: 0.9rem;">
                            {% if 'Learn & Earn' in category %}
                                üìö {{ category }}
                            {% elif '24-Hour' in category %}
                                ‚è∞ {{ category }}
                            {% elif 'Telegram' in category %}
                                üì± {{ category }}
                            {% elif 'Twitter' in category %}
                                üê¶ {{ category }}
                            {% elif 'Community Stories' in category %}
                                üåü {{ category }}
                            {% elif 'Minigames' in category %}
                                üéÆ {{ category }}
                            {% elif 'Forum' in category %}
                                üí¨ {{ category }}
                            {% elif 'Task Completion' in category %}
                                ‚úÖ {{ category }}
                            {% elif 'P2P Trading' in category %}
                                ü§ù {{ category }}
                            {% else %}
                                üíé {{ category }}
                            {% endif %}
                        </div>
                        <div class="stat-value" style="font-size: 1rem; color: #00f2fe;">{{ amount }}</div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 20px; color: rgba(241, 245, 249, 0.5);">
                    Loading disbursement data...
                </div>
            {% endif %}
        </div>

        <!-- Monthly Disbursements (Last 30 Days) -->
        <div class="insight-card" style="background: rgba(0, 242, 254, 0.08); border: 1px solid rgba(0, 242, 254, 0.3);">
            <div class="insight-header">üìÖ Monthly Disbursements (Last 30 Days)</div>

            {% if data.disbursement_analytics and data.disbursement_analytics.monthly_breakdown_formatted %}
                <!-- Date Range Display -->
                {% if data.disbursement_analytics.monthly_date_range %}
                <div style="background: rgba(0, 242, 254, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 0.85rem; color: rgba(241, 245, 249, 0.7); margin-bottom: 4px;">
                        Report Period
                    </div>
                    <div style="font-size: 0.95rem; font-weight: 600; color: #00f2fe;">
                        üìÜ {{ data.disbursement_analytics.monthly_date_range.start_date }} to {{ data.disbursement_analytics.monthly_date_range.end_date }}
                    </div>
                </div>
                {% endif %}

                <div style="margin-top: 1rem;">
                    <div class="stat-row" style="padding: 12px 0; border-bottom: 1px solid rgba(0, 242, 254, 0.2);">
                        <div class="stat-label" style="font-size: 0.95rem; font-weight: 600;">
                            üìö Learn & Earn Quizzes
                        </div>
                        <div class="stat-value" style="font-size: 1.2rem; color: #00f2fe; font-weight: 700;">
                            {{ data.disbursement_analytics.monthly_breakdown_formatted.learn_earn }}
                        </div>
                    </div>

                    <div class="stat-row" style="padding: 12px 0; border-bottom: 1px solid rgba(0, 242, 254, 0.2);">
                        <div class="stat-label" style="font-size: 0.95rem; font-weight: 600;">
                            üì± Telegram Task Posts
                        </div>
                        <div class="stat-value" style="font-size: 1.2rem; color: #4facfe; font-weight: 700;">
                            {{ data.disbursement_analytics.monthly_breakdown_formatted.telegram_task }}
                        </div>
                    </div>

                    <div class="stat-row" style="padding: 12px 0; border-bottom: none;">
                        <div class="stat-label" style="font-size: 0.95rem; font-weight: 600;">
                            üê¶ Twitter Task Rewards
                        </div>
                        <div class="stat-value" style="font-size: 1.2rem; color: #00f2fe; font-weight: 700;">
                            {{ data.disbursement_analytics.monthly_breakdown_formatted.twitter_task }}
                        </div>
                    </div>

                    <div class="stat-row" style="padding: 12px 0; border-bottom: none;">
                        <div class="stat-label" style="font-size: 0.95rem; font-weight: 600;">
                            üåü Community Stories
                        </div>
                        <div class="stat-value" style="font-size: 1.2rem; color: #00f2fe; font-weight: 700;">
                            {{ data.disbursement_analytics.monthly_breakdown_formatted.community_stories }}
                        </div>
                    </div>

                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0, 242, 254, 0.2);">
                        <div class="stat-row" style="padding: 0;">
                            <div class="stat-label" style="font-size: 1rem; font-weight: 700; color: rgba(241, 245, 249, 1);">
                                üìä Monthly Total
                            </div>
                            <div class="stat-value" style="font-size: 1.3rem; color: #00f2fe; font-weight: 800;">
                                {% if data.disbursement_analytics and data.disbursement_analytics.monthly_breakdown %}
                                    {{ (data.disbursement_analytics.monthly_breakdown.get('learn_earn', 0) + data.disbursement_analytics.monthly_breakdown.get('telegram_task', 0) + data.disbursement_analytics.monthly_breakdown.get('twitter_task', 0) + data.disbursement_analytics.monthly_breakdown.get('community_stories', 0)) | round(2) }} G$
                                {% else %}
                                    0.00 G$
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div style="text-align: center; padding: 20px; color: rgba(241, 245, 249, 0.5);">
                    Loading monthly data...
                </div>
            {% endif %}
        </div>

        <!-- Weekly Disbursements (Last 7 Days) -->
        <div class="insight-card" style="background: rgba(79, 172, 254, 0.08); border: 1px solid rgba(79, 172, 254, 0.3);">
            <div class="insight-header">üìÖ Weekly Disbursements (Last 7 Days)</div>

            {% if data.disbursement_analytics and data.disbursement_analytics.weekly_breakdown_formatted %}
                <!-- Date Range Display -->
                {% if data.disbursement_analytics.weekly_date_range %}
                <div style="background: rgba(79, 172, 254, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 0.85rem; color: rgba(241, 245, 249, 0.7); margin-bottom: 4px;">
                        Report Period
                    </div>
                    <div style="font-size: 0.95rem; font-weight: 600; color: #4facfe;">
                        üìÜ {{ data.disbursement_analytics.weekly_date_range.start_date }} to {{ data.disbursement_analytics.weekly_date_range.end_date }}
                    </div>
                </div>
                {% endif %}

                <div style="margin-top: 1rem;">
                    <div class="stat-row" style="padding: 12px 0; border-bottom: 1px solid rgba(79, 172, 254, 0.2);">
                        <div class="stat-label" style="font-size: 0.95rem; font-weight: 600;">
                            üìö Learn & Earn Quizzes
                        </div>
                        <div class="stat-value" style="font-size: 1.2rem; color: #4facfe; font-weight: 700;">
                            {{ data.disbursement_analytics.weekly_breakdown_formatted.learn_earn }}
                        </div>
                    </div>

                    <div class="stat-row" style="padding: 12px 0; border-bottom: none;">
                        <div class="stat-label" style="font-size: 0.95rem; font-weight: 600;">
                            üì± Telegram Task Posts
                        </div>
                        <div class="stat-value" style="font-size: 1.2rem; color: #00f2fe; font-weight: 700;">
                            {{ data.disbursement_analytics.weekly_breakdown_formatted.telegram_task }}
                        </div>
                    </div>

                    <div class="stat-row">
                        <div class="stat-label">üê¶ Twitter Task Rewards</div>
                        <div class="stat-value">
                            {% if data.disbursement_analytics and data.disbursement_analytics.weekly_breakdown_formatted %}
                                {{ data.disbursement_analytics.weekly_breakdown_formatted.get('twitter_task', '0.0 G$') }}
                            {% else %}
                                0.00 G$
                            {% endif %}
                        </div>
                    </div>

                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(79, 172, 254, 0.2);">
                        <div class="stat-row" style="padding: 0;">
                            <div class="stat-label" style="font-size: 1rem; font-weight: 700; color: rgba(241, 245, 249, 1);">
                                Weekly Total
                            </div>
                            <div class="stat-value" style="font-size: 1.3rem; color: #00f2fe; font-weight: 800;">
                                {% if data.disbursement_analytics and data.disbursement_analytics.weekly_breakdown %}
                                    {{ (data.disbursement_analytics.weekly_breakdown.get('learn_earn', 0) + data.disbursement_analytics.weekly_breakdown.get('telegram_task', 0) + data.disbursement_analytics.weekly_breakdown.get('twitter_task', 0)) | round(2) }} G$
                                {% else %}
                                    0.00 G$
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div style="text-align: center; padding: 20px; color: rgba(241, 245, 249, 0.5);">
                    Loading weekly data...
                </div>
            {% endif %}
        </div>

        <!-- Learn & Earn Daily Participants -->
        <div class="insight-card" style="background: rgba(124, 58, 237, 0.08); border: 1px solid rgba(124, 58, 237, 0.3);">
            <div class="insight-header">üìö Learn & Earn - Today's Participants</div>

            <div style="margin-bottom: 1rem;">
                <input type="date" id="participantDate" style="padding: 8px; border-radius: 8px; border: 1px solid rgba(124, 58, 237, 0.3); background: white; color: #1f2937; width: 100%; max-width: 200px;">
                <button onclick="loadParticipants()" style="padding: 8px 16px; margin-left: 8px; background: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer;">Load Participants</button>
            </div>

            <div id="participantsSummary" style="background: rgba(124, 58, 237, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-weight: 600;">Total Participants:</span>
                    <span id="totalParticipants" style="color: #7c3aed; font-weight: 700;">0</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="font-weight: 600;">Total G$ Disbursed:</span>
                    <span id="totalDisbursed" style="color: #7c3aed; font-weight: 700;">0.00 G$</span>
                </div>
            </div>

            <div id="participantsList" style="max-height: 400px; overflow-y: auto;">
                <div style="text-align: center; padding: 20px; color: #6b7280;">
                    Loading today's participants...
                </div>
            </div>
        </div>

        <!-- Platform Analytics -->
        <div class="insight-card">
            <div class="insight-header">üìà Platform Insights</div>
            <div class="stat-row">
                <div class="stat-label">Total Platform Users</div>
                <div class="stat-value">{{ data.platform_stats.metrics.total_users }}</div>
            </div>
            <div class="stat-row">
                <div class="stat-label">Learn & Earn Completions</div>
                <div class="stat-value">{{ data.platform_stats.user_activity.learn_earn_completions }}</div>
            </div>
            <div class="stat-row">
                <div class="stat-label">12-Hour Bonus Claims</div>
            </div>
            <div class="stat-row">
                <div class="stat-label">Feature Users</div>
                <div class="stat-value">{{ data.gooddollar_info.platform_features.total_feature_users }}</div>
            </div>
            <div class="stat-row">
                <div class="stat-label">Verification Success Rate</div>
                <div class="stat-value">{{ data.platform_stats.verification_stats.success_rate }}</div>
            </div>
        </div>

        <button class="refresh-btn" onclick="refreshAnalytics()">üîÑ Refresh Analytics</button>
    </div>

    <script>
        function refreshAnalytics() {
            window.location.reload();
        }

        // Global error handler for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('‚ùå Unhandled Promise Rejection:', event.reason);
            // Prevent the browser's default error handling
            event.preventDefault();
        });

        // Track analytics - Define function or remove calls
        function trackAnalyticsEvent(event) {
            try {
                fetch('/track-analytics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event: event,
                        wallet: '{{ wallet }}'
                    })
                });
            } catch (error) {
                console.log('Analytics tracking failed:', error);
            }
        }

        // Track page load
        trackAnalyticsEvent('overview_loaded');

        async function safeFetch(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) return { success: false, data: [] };
                return await response.json();
            } catch (e) {
                return { success: false, data: [] };
            }
        }

        async function fetchUserHistory() {
            try {
                const [learnEarnData, telegramData, p2pData, minigamesData] = await Promise.all([
                    safeFetch('/learn-earn/quiz-history?limit=100'),
                    safeFetch('/api/telegram-task/transaction-history?limit=50'),
                    safeFetch('/api/p2p/history?limit=50'),
                    safeFetch('/minigames/api/transaction-history?limit=50')
                ]);

                console.log('üìä User History Loaded:', { learnEarn: learnEarnData, telegram: telegramData, p2p: p2pData, minigames: minigamesData });

                return { learnEarn: learnEarnData, telegram: telegramData, p2p: p2pData, minigames: minigamesData };
            } catch (error) {
                console.error('Error fetching user history:', error);
                return null;
            }
        }

        // Load history on page load
        window.addEventListener('load', async function() {
            const history = await fetchUserHistory();
            if (history) {
                console.log('‚úÖ Complete user history loaded successfully');
            }
        });

        // Show loading message when navigating to dashboard
        function showDashboardLoading(event) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            // Show processing message
            btn.innerHTML = '<span style="display: flex; align-items: center; gap: 8px;"><div class="loading-spinner" style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; margin: 0;"></div> Loading Dashboard...</span>';
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.8';
            
            // Allow navigation to proceed
            return true;
        }

        // Placeholder for fetchUserBalance
        function fetchUserBalance() {
            console.log("Fetching user balance...");
            // In a real application, this function would fetch the user's balance.
            // For this example, we'll just log a message.
        }

        // Placeholder for trackAnalytics, assuming it's defined elsewhere or will be added
        function trackAnalytics(event) {
            console.log("Tracking analytics event:", event);
            // In a real application, this function would send analytics data.
        }

        // Update balance display function
        function updateBalanceDisplay(data) {
            console.log('Updating Balance Display with:', data);

            const userBalanceElement = document.getElementById('user-balance');
            const contractAddressElement = document.getElementById('contract-address');

            if (data && data.success) {
                if (userBalanceElement) {
                    userBalanceElement.textContent = data.balance_formatted || 'Error';
                }
                if (contractAddressElement) {
                    const address = data.contract || 'Unknown';
                    contractAddressElement.textContent = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                    contractAddressElement.title = address; // Show full address on hover
                }
            } else {
                if (userBalanceElement) {
                    userBalanceElement.textContent = 'Error loading';
                }
                if (contractAddressElement) {
                    contractAddressElement.textContent = 'Error loading';
                }
            }
        }



        // Placeholder for updateLearnEarnUI, assuming it's defined elsewhere or will be added
        function updateLearnEarnUI(data) {
            console.log('Updating Learn & Earn UI with:', data);
            // In a real application, this function would update the UI based on the fetched data.
        }

        // Fetch all necessary data on load
        function loadAnalyticsData() {
            const walletAddress = "{{ wallet }}"; // Assuming wallet is available in the template context

            // Load Learn & Earn eligibility
            fetch('/learn-earn/eligibility')
                .then(response => response.json())
                .then(data => {
                    console.log('Learn & Earn Eligibility Raw Response:', JSON.stringify(data, null, 2));
                    console.log('Learn & Earn Eligibility Parsed Data:', data);

                    updateLearnEarnUI(data);
                })
                .catch(error => {
                    console.error('‚ùå Learn & Earn API Error:', error);
                    // Assuming there's an element with id 'learn-earn-status' to display errors
                    const learnEarnStatusElement = document.getElementById('learn-earn-status');
                    if (learnEarnStatusElement) {
                        learnEarnStatusElement.innerHTML = '<span class="text-danger">‚ö†Ô∏è Error loading data</span>';
                    }
                });

            // Load wallet balance
            fetch(`/api/balance/${encodeURIComponent(walletAddress)}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Balance API Raw Response:', JSON.stringify(data, null, 2));
                    console.log('Balance API Parsed Data:', data);

                    updateBalanceDisplay(data);
                })
                .catch(error => {
                    console.error('‚ùå Balance API Error:', error);
                    // Assuming there's an element with id 'balance-display' to display errors
                    const balanceDisplayElement = document.getElementById('balance-display');
                    if (balanceDisplayElement) {
                        balanceDisplayElement.innerHTML = '<span class="text-danger">‚ö†Ô∏è Error loading balance</span>';
                    }
                });
        }

        // Helper function to show notification messages
        function showNotification(message, type = 'info') {
            const notificationContainer = document.createElement('div');
            notificationContainer.className = `notification-message ${type}`;
            notificationContainer.textContent = message;
            document.body.appendChild(notificationContainer);

            // Remove the notification after a delay
            setTimeout(() => {
                notificationContainer.remove();
            }, 5000); // 5 seconds duration
        }

        // Check admin status on page load
        async function checkAdminStatus() {
            try {
                const response = await fetch('/api/admin/check');
                const data = await response.json();

                if (data.success && data.is_admin) {
                    console.log('‚úÖ Admin access detected for:', data.wallet);
                    const adminLink = document.getElementById('adminLink');
                    if (adminLink) {
                        adminLink.style.display = 'inline-block';
                        console.log('‚úÖ Admin link now visible');
                    }
                } else {
                    console.log('‚ÑπÔ∏è User is not an admin');
                }
            } catch (error) {
                console.error('‚ùå Admin check failed:', error);
            }
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', function() {
            const wallet = '{{ wallet if wallet else "" }}';
            if (wallet && wallet !== 'None' && wallet !== '') {
                checkAdminStatus();
                loadAnalyticsData();
            }

            // Set today's date as default (use local timezone)
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayString = `${yyyy}-${mm}-${dd}`;

            document.getElementById('participantDate').value = todayString;

            // Auto-load today's participants after a short delay
            setTimeout(() => {
                loadParticipants();
            }, 500);
        });

        // Load Learn & Earn participants for selected date
        async function loadParticipants() {
            try {
                const dateInput = document.getElementById('participantDate');
                const selectedDate = dateInput.value;

                if (!selectedDate) {
                    alert('Please select a date');
                    return;
                }

                console.log(`üìä Loading participants for ${selectedDate}...`);

                const response = await fetch(`/api/learn-earn-participants?date=${selectedDate}`);
                const data = await response.json();

                console.log('Participants data:', data);

                if (data.success) {
                    // Update summary
                    document.getElementById('totalParticipants').textContent = data.total_count || 0;
                    document.getElementById('totalDisbursed').textContent = data.total_g_disbursed_formatted || '0.00 G$';

                    // Update participants list
                    const listContainer = document.getElementById('participantsList');

                    if (!data.participants || data.participants.length === 0) {
                        listContainer.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #6b7280;">
                                No participants found for ${selectedDate}
                            </div>
                        `;
                    } else {
                        let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';

                        data.participants.forEach((participant, index) => {
                            html += `
                                <div style="background: rgba(124, 58, 237, 0.05); padding: 12px; border-radius: 8px; border: 1px solid rgba(124, 58, 237, 0.2);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                        <div>
                                            <span style="font-weight: 600; color: #7c3aed;">#${index + 1}</span>
                                            <span style="margin-left: 8px; font-weight: 600; color: #1f2937;">${participant.display_name}</span>
                                        </div>
                                        <div style="font-weight: 700; color: #7c3aed; font-size: 1.1rem;">
                                            ${participant.amount_formatted}
                                        </div>
                                    </div>
                                    <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 4px;">
                                        <strong>Wallet:</strong> ${participant.wallet_address}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 4px;">
                                        <strong>TX Hash:</strong>
                                        ${participant.transaction_hash && participant.transaction_hash !== 'N/A'
                                            ? `<a href="https://explorer.celo.org/mainnet/tx/${participant.transaction_hash}" target="_blank" style="color: #4facfe; text-decoration: underline;">${participant.transaction_hash.substring(0, 10)}...${participant.transaction_hash.substring(participant.transaction_hash.length - 8)}</a>`
                                            : 'N/A'
                                        }
                                    </div>
                                    <div style="font-size: 0.85rem; color: #6b7280;">
                                        <strong>Time:</strong> ${new Date(participant.timestamp).toLocaleString()}
                                    </div>
                                </div>
                            `;
                        });

                        html += '</div>';
                        listContainer.innerHTML = html;
                    }

                    console.log(`‚úÖ Loaded ${data.total_count} participants for ${selectedDate}`);
                } else {
                    console.error('‚ùå Failed to load participants:', data.error);
                    const listContainer = document.getElementById('participantsList');
                    listContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #ef4444;">
                            ‚ö†Ô∏è Failed to load participants. Please try again.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error loading participants:', error);
                const listContainer = document.getElementById('participantsList');
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #ef4444;">
                        ‚ö†Ô∏è Error loading participants. Please try again.
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
