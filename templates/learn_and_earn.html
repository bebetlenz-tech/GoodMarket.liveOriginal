<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learn & Earn - GoodDollar Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #ffffff;
            position: relative;
            overflow-x: hidden;
            zoom: 0.6;
        }

        

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
            position: relative;
            z-index: 1;
        }

        .header {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(255, 255, 255, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: slideDown 0.5s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header::before {
            content: 'üéì';
            position: absolute;
            font-size: 200px;
            opacity: 0.05;
            top: -50px;
            right: -30px;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header h1 {
            color: #ffffff;
            margin-bottom: 8px;
            font-size: 2.2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: slideDown 0.6s ease-out 0.1s both;
        }

        .header p {
            color: #cccccc;
            font-size: 1.1rem;
            animation: slideDown 0.6s ease-out 0.2s both;
        }

        .quiz-info {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(255, 255, 255, 0.1);
            animation: slideUp 0.6s ease-out 0.3s both;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quiz-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 18px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            animation: fadeInScale 0.6s ease-out both;
            cursor: pointer;
        }

        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation-delay: 0.4s;
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation-delay: 0.5s;
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            animation-delay: 0.6s;
        }

        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            animation-delay: 0.7s;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 6px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stat-card p {
            opacity: 1;
            font-size: 0.95rem;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .quiz-section {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(255, 255, 255, 0.1);
            animation: slideUp 0.6s ease-out 0.5s both;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .quiz-section::before {
            content: 'üìö';
            position: absolute;
            font-size: 150px;
            opacity: 0.03;
            bottom: -30px;
            left: -20px;
        }

        .quiz-section h2 {
            color: #ffffff;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.6rem;
            font-weight: bold;
            position: relative;
        }

        .quiz-section h2::after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 10px auto 0;
            border-radius: 2px;
        }

        .start-quiz-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }

        .start-quiz-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .start-quiz-btn:hover::before {
            left: 100%;
        }

        .start-quiz-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
        }

        .start-quiz-btn:active {
            transform: translateY(-1px);
        }

        .start-quiz-btn:disabled {
            background: linear-gradient(135deg, #cbd5e0, #a0aec0);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .start-quiz-btn:disabled::before {
            display: none;
        }

        .eligibility-status {
            padding: 20px 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 500;
            animation: bounceIn 0.6s ease-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
            }
        }

        .eligibility-eligible {
            background: linear-gradient(135deg, #d4edda, #b8e6c0);
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .eligibility-blocked {
            background: linear-gradient(135deg, #f8d7da, #f5c2c7);
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .quiz-history {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(255, 255, 255, 0.1);
            animation: slideUp 0.6s ease-out 0.7s both;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .quiz-history h2 {
            color: #ffffff;
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .quiz-history h2::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-top: 10px;
            border-radius: 2px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .history-table th,
        .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .history-table th:nth-child(4),
        .history-table td:nth-child(4) {
            text-align: center;
        }

        .history-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            font-size: 1.05rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-table tbody tr {
            transition: all 0.3s ease;
        }

        .history-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: scale(1.01);
        }

        .tx-hash-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            font-family: monospace;
            transition: all 0.3s ease;
        }

        .tx-hash-link:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .back-btn {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: slideDown 0.5s ease-out;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #5a6268, #6c757d);
        }

        .loading {
            text-align: center;
            padding: 30px;
        }

        .loading p {
            margin-top: 15px;
            color: #ffffff;
            font-weight: 500;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
        }

        .notification {
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            min-width: 300px;
            max-width: 500px;
            font-size: 1.1rem;
            font-weight: 500;
            animation: bounceIn 0.5s ease-out;
        }

        .notification.success {
            background: linear-gradient(135deg, #d4edda, #b8e6c0);
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .notification.error {
            background: linear-gradient(135deg, #f8d7da, #f5c2c7);
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .notification.info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 2px solid #bee5eb;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }

        /* Feature Badge */
        .feature-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(245, 87, 108, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 10px rgba(245, 87, 108, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 15px rgba(245, 87, 108, 0.6);
            }
        }

        /* Enhanced quiz container */
        #quiz-container {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: inset 0 2px 10px rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #quiz-container h3 {
            color: #000000;
            font-size: 1.4rem;
            margin-bottom: 20px;
            line-height: 1.6;
            text-shadow: none;
            font-weight: 900;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
        }

        #quiz-container label {
            transition: all 0.3s ease;
            cursor: pointer;
            color: #000000 !important;
            font-weight: 700;
            text-shadow: none;
        }

        #quiz-container label:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            transform: translateX(5px);
        }

        #quiz-container input[type="radio"]:checked + label {
            background: linear-gradient(135deg, #667eea15, #764ba215) !important;
            border-left: 4px solid #667eea;
        }

        /* Results Container */
        .results-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            padding: 2rem;
        }

        .results-content {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        /* Achievement Card Styles */
        .achievement-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 2.5rem;
            margin: 2rem 0;
            color: white;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }

        .achievement-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-20%, -20%); }
        }

        .achievement-header {
            position: relative;
            z-index: 1;
            margin-bottom: 1.5rem;
        }

        .achievement-icon {
            width: 80px;
            height: 80px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .achievement-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 1rem 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .achievement-badge {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
            z-index: 1;
        }

        .badge-rank {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        }

        .badge-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .achievement-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
            position: relative;
            z-index: 1;
        }

        .stat-item {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(5px);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .achievement-footer {
            margin-top: 1.5rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .achievement-date {
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .btn-share {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-share:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* Timer Display Styles */
        .timer-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .timer-text {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .timer-value {
            font-size: 2rem;
            font-weight: bold;
        }

        /* Timer Warning Animation */
        .timer-warning {
            animation: pulse-red 1s infinite;
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
        }

        @keyframes pulse-red {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }
        }

        #question-timer {
            font-size: 2.5rem;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        /* Achievement Modal Styles */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); }
            50% { transform: translateY(-20px) translateX(10px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/overview" class="back-btn">‚Üê Back to Overview</a>

        <div class="header">
            <h1><i class="fas fa-graduation-cap"></i> Learn & Earn</h1>
            <p>Complete quizzes about GoodDollar and earn G$ rewards!</p>
        </div>

        <div class="quiz-info">
            <div class="quiz-stats">
                <div class="stat-card">
                    <h3>10</h3>
                    <p>Questions per Quiz</p>
                </div>
                <div class="stat-card">
                    <h3>200 G$</h3>
                    <p>Per Correct Answer</p>
                </div>
                <div class="stat-card">
                    <h3>2000 G$</h3>
                    <p>Maximum Reward</p>
                </div>
                <div class="stat-card">
                    <h3>20s</h3>
                    <p>Time per Question</p>
                </div>
            </div>
        </div>

        <div id="notification" class="notification"></div>

        <div class="quiz-section">
            <h2>Take Quiz</h2>

            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading quiz status...</p>
            </div>

            <div id="eligibility-status" class="eligibility-status" style="display: none;"></div>

            <button id="start-quiz-btn" class="start-quiz-btn" disabled>
                <i class="fas fa-play"></i> Start Quiz
            </button>

            <!-- Audio Elements for Sound Effects -->
    <audio id="timer-tick" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="timer-warning" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="success-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="clap-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/1408/1408-preview.mp3" type="audio/mpeg">
    </audio>

    <!-- Quiz Container -->
    <div id="quiz-container" class="quiz-container" style="display: none;">
            </div>

        <div class="quiz-history">
            <h2><i class="fas fa-history"></i> Quiz History</h2>
            <div id="history-loading" class="loading">
                <div class="spinner"></div>
                <p>Loading quiz history...</p>
            </div>
            <div id="history-content" style="display: none;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Score</th>
                            <th>Reward</th>
                            <th>TX</th>
                            <th>Achievement</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Results Container -->
    <div id="results-container" class="results-container" style="display: none;">
        <div class="results-content">
            <h2 id="results-title">Quiz Completed!</h2>
            <div id="results-details"></div>

            <!-- Achievement Card (Shareable) -->
    <div id="achievement-card" class="achievement-card" style="display: none;">
        <div class="achievement-header">
            <img src="https://img.icons8.com/fluency/96/trophy.png" alt="Trophy" class="achievement-icon">
            <h2 class="achievement-title">üéâ Congratulations!</h2>
        </div>
        <div class="achievement-badge" id="achievement-badge">
            <div class="badge-rank" id="badge-rank">ü•á RANK #1</div>
            <div class="badge-subtitle" id="badge-subtitle">Daily Quiz Champion</div>
        </div>
        <div class="achievement-stats">
            <div class="stat-item">
                <div class="stat-label">Username</div>
                <div class="stat-value" id="achievement-username">User</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Score</div>
                <div class="stat-value" id="achievement-score">10/10</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Earned</div>
                <div class="stat-value" id="achievement-reward">2000 G$</div>
            </div>
        </div>
        <div class="achievement-footer">
            <p>GoodDollar Learn & Earn</p>
            <p class="achievement-date" id="achievement-date">Dec 14, 2025</p>
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn-share" id="sell-achievement-btn" style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706);">
            <span>üí∞ Sell This Card</span>
        </button>
        <button class="btn-share" id="download-achievement-btn" style="display: none;">
            <span>üì• Download Achievement Card</span>
        </button>
        <button class="btn-share" id="share-twitter" style="display: none;">
            <span>üê¶ Share on Twitter</span>
        </button>
        <button class="btn-share" id="share-telegram" style="display: none;">
            <span>‚úàÔ∏è Share on Telegram</span>
        </button>
    </div>

            <button class="btn-primary" onclick="location.reload()">Take Another Quiz</button>
        </div>
    </div>

    <!-- Achievement Modal -->
    <div id="achievement-modal" style="display: none;"></div>

    <!-- Load html2canvas globally -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script type="module">
        let quizData = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let quizSessionId = null;
        let questionTimer = null;
        let timeRemaining = 20;
        let quizSettings = {
            questions_per_quiz: 10,
            time_per_question: 20,
            max_reward_per_quiz: 2000,
            reward_per_correct: 200
        };

        let quizHistory = []; // Store quiz history globally for showHistoryAchievement

        // Audio context for sound effects
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Sound effect functions
        function playTickSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function playUrgentSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 1200;
            oscillator.type = 'square';

            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.15);

            // Second beep
            setTimeout(() => {
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();

                osc2.connect(gain2);
                gain2.connect(audioContext.destination);

                osc2.frequency.value = 1200;
                osc2.type = 'square';

                gain2.gain.setValueAtTime(0.2, audioContext.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

                osc2.start(audioContext.currentTime);
                osc2.stop(audioContext.currentTime + 0.15);
            }, 200);
        }

        function playClapSound() {
            try {
                const clapSound = document.getElementById('clap-sound');
                if (clapSound) {
                    clapSound.currentTime = 0;
                    clapSound.play().catch(e => console.log('Audio play failed:', e));
                }
            } catch (e) {
                console.log('Clap sound error:', e);
            }
        }

        // Load quiz settings
        async function loadQuizSettings() {
            try {
                const response = await fetch('/api/admin/quiz-settings');
                const data = await response.json();

                if (data.success) {
                    quizSettings = data.settings;

                    // Update UI with dynamic settings
                    const statCards = document.querySelectorAll('.stat-card');
                    if (statCards.length >= 4) {
                        statCards[0].querySelector('h3').textContent = quizSettings.questions_per_quiz;
                        statCards[1].querySelector('h3').textContent = Math.round(quizSettings.reward_per_correct) + ' G$';
                        statCards[2].querySelector('h3').textContent = quizSettings.max_reward_per_quiz + ' G$';
                        statCards[3].querySelector('h3').textContent = quizSettings.time_per_question + 's';
                    }

                    timeRemaining = quizSettings.time_per_question;
                }
            } catch (error) {
                console.error('Error loading quiz settings:', error);
            }
        }

        // Check eligibility and load quiz status
        async function checkEligibility() {
            try {
                document.getElementById('loading').style.display = 'block';

                const response = await fetch('/learn-earn/eligibility');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                console.log('Eligibility check:', data);

                const statusDiv = document.getElementById('eligibility-status');
                const startBtn = document.getElementById('start-quiz-btn');

                // Handle authentication/verification required
                if (data.auth_required) {
                    statusDiv.className = 'eligibility-status eligibility-blocked';
                    statusDiv.innerHTML = `<i class="fas fa-lock"></i> ${data.message}`;
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-lock"></i> Login Required';
                    statusDiv.style.display = 'block';
                    return;
                }

                if (data.verification_required) {
                    statusDiv.className = 'eligibility-status eligibility-blocked';
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.message}`;
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Verification Required';
                    statusDiv.style.display = 'block';
                    return;
                }

                // Handle eligibility status
                if (data.success && data.eligible && !data.blocked) {
                    statusDiv.className = 'eligibility-status eligibility-eligible';
                    statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message}`;
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Start Quiz';
                } else {
                    statusDiv.className = 'eligibility-status eligibility-blocked';
                    statusDiv.innerHTML = `<i class="fas fa-clock"></i> ${data.message || 'Quiz not available'}`;
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-clock"></i> Quiz on Cooldown';
                }

                statusDiv.style.display = 'block';
            } catch (error) {
                console.error('‚ùå Learn & Earn Eligibility Error:', error);
                const statusDiv = document.getElementById('eligibility-status');
                const startBtn = document.getElementById('start-quiz-btn');

                statusDiv.className = 'eligibility-status eligibility-blocked';
                statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Failed to check quiz eligibility. Please refresh the page.`;
                statusDiv.style.display = 'block';
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Start quiz
        async function startQuiz() {
            try {
                showNotification('Starting quiz...', 'info');

                const response = await fetch('/learn-earn/start-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    quizData = data.quiz_session.questions;
                    quizSessionId = data.quiz_session.session_id;
                    moduleLinks = data.quiz_session.module_links || [];
                    userAnswers = new Array(quizData.length).fill(-1);
                    currentQuestionIndex = 0;
                    clickedModuleLinks = new Set(); // Reset clicked links

                    displayQuiz();
                    showNotification('Quiz started successfully!', 'success');
                } else {
                    const errorMsg = data.error || 'Failed to start quiz';
                    const notificationType = data.high_demand ? 'info' : 'error';
                    showNotification(errorMsg, notificationType);

                    // If high demand, update the eligibility status UI
                    if (data.high_demand) {
                        const statusDiv = document.getElementById('eligibility-status');
                        statusDiv.className = 'eligibility-status eligibility-blocked';
                        statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMsg}`;
                        statusDiv.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error starting quiz:', error);
                showNotification('Failed to start quiz', 'error');
            }
        }

        // Track which module links have been clicked
        let clickedModuleLinks = new Set();
        let moduleLinks = [];

        // Display quiz questions
        function displayQuiz() {
            const container = document.getElementById('quiz-container');
            const startBtn = document.getElementById('start-quiz-btn');

            startBtn.style.display = 'none';
            container.style.display = 'block';

            // Show module links first if available
            if (moduleLinks && moduleLinks.length > 0) {
                displayModuleLinks();
            } else {
                displayQuestion();
            }
        }

        // Display module links that must be clicked before quiz
        function displayModuleLinks() {
            const container = document.getElementById('quiz-container');

            const allLinksClicked = clickedModuleLinks.size === moduleLinks.length;

            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 style="color: #667eea; margin-bottom: 1rem;">üìö Required Study Materials</h2>
                    <p style="color: rgba(241, 245, 249, 0.8); font-size: 1.1rem;">
                        Please click and review all module links below before starting the quiz
                    </p>
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255, 215, 0, 0.1); border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.3);">
                        <strong style="color: #fbbf24;">üìñ Progress: ${clickedModuleLinks.size}/${moduleLinks.length} modules reviewed</strong>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
                    ${moduleLinks.map((link, index) => {
                        const isClicked = clickedModuleLinks.has(link.id);
                        return `
                            <div style="padding: 1.5rem; background: ${isClicked ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255, 255, 255, 0.05)'}; border-radius: 12px; border: 2px solid ${isClicked ? '#10b981' : 'rgba(255, 255, 255, 0.2)'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                    <div style="flex: 1;">
                                        <h3 style="margin-bottom: 0.5rem; color: ${isClicked ? '#10b981' : '#f1f5f9'};">
                                            ${isClicked ? '‚úÖ' : 'üìñ'} ${link.title}
                                        </h3>
                                        ${link.description ? `<p style="color: rgba(241, 245, 249, 0.7); font-size: 0.9rem; margin-bottom: 0.5rem;">${link.description}</p>` : ''}
                                    </div>
                                </div>
                                <a href="${link.url}" 
                                   target="_blank" 
                                   onclick="markModuleLinkClicked(${link.id})"
                                   style="display: inline-block; padding: 0.75rem 1.5rem; background: ${isClicked ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #667eea, #764ba2)'}; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;">
                                    ${isClicked ? '‚úÖ Reviewed' : 'üîó Open Module'}
                                </a>
                            </div>
                        `;
                    }).join('')}
                </div>

                <button 
                    onclick="proceedToQuiz()" 
                    ${!allLinksClicked ? 'disabled' : ''} 
                    style="width: 100%; padding: 1.25rem; background: ${allLinksClicked ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #cbd5e0, #a0aec0)'}; color: white; border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: ${allLinksClicked ? 'pointer' : 'not-allowed'};">
                    ${allLinksClicked ? '‚úÖ Start Quiz Now' : 'üîí Review All Modules to Continue'}
                </button>
            `;
        }

        // Mark module link as clicked
        window.markModuleLinkClicked = function(linkId) {
            setTimeout(() => {
                clickedModuleLinks.add(linkId);
                displayModuleLinks(); // Refresh display
            }, 500);
        };

        // Proceed to quiz after all links are clicked
        window.proceedToQuiz = function() {
            currentQuestionIndex = 0;
            displayQuestion();
        };

        // Start question timer
        function startQuestionTimer() {
            // Clear any existing timer
            if (questionTimer) {
                clearInterval(questionTimer);
            }

            // Reset time to configured seconds
            timeRemaining = quizSettings.time_per_question;
            updateTimerDisplay();

            // Start countdown
            questionTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();

                // Auto-advance when time runs out
                if (timeRemaining <= 0) {
                    clearInterval(questionTimer);
                    autoAdvanceQuestion();
                }
            }, 1000);
        }

        // Update timer display
        function updateTimerDisplay() {
            const timerElement = document.getElementById('question-timer');
            const timerDisplay = document.getElementById('timer-display');

            if (timerElement) {
                timerElement.textContent = timeRemaining;

                // Change color and play sounds based on time remaining
                if (timeRemaining <= 5) {
                    timerElement.style.color = '#dc3545';
                    if (timerDisplay) {
                        timerDisplay.classList.add('timer-warning');
                    }
                    // Play urgent warning sound for last 5 seconds
                    try {
                        const warningSound = document.getElementById('timer-warning');
                        if (warningSound) {
                            warningSound.currentTime = 0;
                            warningSound.play().catch(e => console.log('Audio play failed:', e));
                        }
                    } catch (e) {
                        console.log('Warning sound error:', e);
                    }
                } else if (timeRemaining <= 10) {
                    timerElement.style.color = '#ffc107';
                    if (timerDisplay) {
                        timerDisplay.classList.remove('timer-warning');
                    }
                    // Play tick sound for last 10 seconds
                    try {
                        const tickSound = document.getElementById('timer-tick');
                        if (tickSound) {
                            tickSound.currentTime = 0;
                            tickSound.play().catch(e => console.log('Audio play failed:', e));
                        }
                    } catch (e) {
                        console.log('Tick sound error:', e);
                    }
                } else {
                    timerElement.style.color = '#28a745';
                    if (timerDisplay) {
                        timerDisplay.classList.remove('timer-warning');
                    }
                }
            }
        }

        // Auto-advance to next question or submit
        function autoAdvanceQuestion() {
            // If no answer selected, mark as -1 (unanswered)
            if (userAnswers[currentQuestionIndex] === -1) {
                showNotification('Time expired! Moving to next question.', 'info');
            }

            // Move to next question or submit
            if (currentQuestionIndex < quizData.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
                startQuestionTimer();
            } else {
                // Auto-submit quiz
                showNotification('Quiz time completed! Submitting answers...', 'info');
                submitQuiz();
            }
        }

        // Display current question
        function displayQuestion() {
            const container = document.getElementById('quiz-container');
            const question = quizData[currentQuestionIndex];

            container.innerHTML = `
                <div class="timer-display" id="timer-display">
                    <div class="timer-text">Time Remaining</div>
                    <div id="question-timer" class="timer-value">${quizSettings.time_per_question}</div>
                    <div style="font-size: 0.8rem; margin-top: 5px;">seconds</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
                        <span>Question ${currentQuestionIndex + 1} of ${quizData.length}</span>
                    </div>
                    <h3>${question.question}</h3>
                </div>

                <div style="margin-bottom: 30px;">
                    ${question.options.map((option, index) => `
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                                <input type="radio" name="answer" value="${index}" style="margin-right: 10px;"
                                       ${userAnswers[currentQuestionIndex] === index ? 'checked' : ''}>
                                ${option}
                            </label>
                        </div>
                    `).join('')}
                </div>

                <div style="display: flex; justify-content: flex-end;">
                    ${currentQuestionIndex === quizData.length - 1 ?
                        '<button onclick="submitQuiz()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px;"><i class="fas fa-check"></i> Submit Quiz</button>' :
                        '<button onclick="nextQuestion()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">Next <i class="fas fa-arrow-right"></i></button>'
                    }
                </div>
            `;

            // Add event listeners for radio buttons with auto-advance
            const radioButtons = container.querySelectorAll('input[name="answer"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    userAnswers[currentQuestionIndex] = parseInt(this.value);

                    // Auto-advance after selecting answer (with small delay)
                    setTimeout(() => {
                        clearInterval(questionTimer);
                        autoAdvanceQuestion();
                    }, 500);
                });
            });

            // Start timer for this question
            startQuestionTimer();
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizData.length - 1) {
                // Clear timer before moving to next question
                if (questionTimer) {
                    clearInterval(questionTimer);
                }
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        // Submit quiz
        async function submitQuiz() {
            // Clear timer
            if (questionTimer) {
                clearInterval(questionTimer);
            }

            try {
                showNotification('Submitting quiz...', 'info');

                const response = await fetch('/learn-earn/submit-quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        answers: userAnswers,
                        quiz_session_id: quizSessionId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showQuizResults(data);
                    loadQuizHistory(); // Refresh history
                    checkEligibility(); // Refresh eligibility
                } else {
                    showNotification(data.message || 'Failed to submit quiz', 'error');
                }
            } catch (error) {
                console.error('Error submitting quiz:', error);
                showNotification('Failed to submit quiz', 'error');
            }
        }

        // Show quiz results with achievement card
        async function showQuizResults(data) {
            const container = document.getElementById('quiz-container');

            console.log(`üìä Quiz Results Data:`, data);

            container.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <h2><i class="fas fa-trophy"></i> Quiz Complete!</h2>
                    <div style="margin: 20px 0;">
                        <h3>Score: ${data.score}/${data.total_questions}</h3>
                        <h3>Reward: ${data.rewards} G$</h3>
                    </div>

                    ${data.transaction_hash ?
                        `<p style="color: #28a745;"><i class="fas fa-check-circle"></i> Reward sent successfully!</p>
                         <p style="word-break: break-all; font-size: 0.9em;">TX: ${data.transaction_hash}</p>` :
                        '<p style="color: #dc3545;"><i class="fas fa-exclamation-circle"></i> Reward processing failed</p>'
                    }

                    <button id="view-achievement-btn"
                            data-score="${data.score}"
                            data-total="${data.total_questions}"
                            data-reward="${data.rewards}"
                            style="margin: 20px 10px; padding: 12px 25px; background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                        <i class="fas fa-trophy"></i> View Achievement Card
                    </button>

                    <button id="reset-quiz-btn" style="margin: 20px 10px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px;">
                        <i class="fas fa-redo"></i> Take Another Quiz
                    </button>
                </div>
            `;

            showNotification(data.message, data.disbursement_success ? 'success' : 'error');

            // Add event listeners for buttons
            const viewAchievementBtn = document.getElementById('view-achievement-btn');
            if (viewAchievementBtn) {
                viewAchievementBtn.addEventListener('click', function() {
                    const score = parseInt(this.dataset.score);
                    const total = parseInt(this.dataset.total);
                    const reward = parseInt(this.dataset.reward);
                    console.log(`üéØ Achievement card clicked - Score: ${score}/${total}, Reward: ${reward}`);
                    showAchievementCard(score, total, reward);
                });
            }

            const resetBtn = document.getElementById('reset-quiz-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetQuiz);
            }

            // Play clap sound on success
            if (data.disbursement_success) {
                playClapSound();
                // Auto-show achievement card after 2 seconds
                setTimeout(() => {
                    showAchievementCard(data.score, data.total_questions, data.rewards);
                }, 2000);
            }
        }

        // Show achievement card in modal - simplified without username and ranking
        async function showAchievementCard(score, total, reward, soldInfo = {}) {
            const modal = document.getElementById('achievement-modal');
            modal.style.display = 'flex';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.3s ease-out;
            `;

            const percentage = Math.round((score / total) * 100);
            const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            modal.innerHTML = `
                <div style="background: white; border-radius: 24px; padding: 0; max-width: 520px; position: relative; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div id="achievement-card" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; color: white; text-align: center; position: relative;">
                        <!-- Animated background -->
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.15) 0%, transparent 70%); animation: pulse 3s infinite;"></div>

                        <!-- Trophy Icon -->
                        <img src="https://img.icons8.com/fluency/96/trophy.png" alt="Trophy" style="width: 80px; height: 80px; animation: bounce 2s infinite; filter: drop-shadow(0 8px 16px rgba(0,0,0,0.3));">
                        <h2 style="margin: 0 0 8px 0; font-size: 2.2rem; font-weight: 800; text-shadow: 2px 2px 8px rgba(0,0,0,0.3); position: relative; z-index: 1;">Quiz Completed!</h2>
                        <p style="margin: 0 0 25px 0; opacity: 0.95; font-size: 1.05rem; position: relative; z-index: 1;">${today}</p>

                        ${soldInfo && soldInfo.already_sold ? `
                        <div style="background: rgba(239, 68, 68, 0.2); border: 2px solid rgba(239, 68, 68, 0.5); border-radius: 12px; padding: 10px 20px; margin: 10px 0;">
                            <span style="font-size: 1.1rem; font-weight: 700;">‚úÖ ALREADY SOLD FOR ${soldInfo.sell_price} G$</span>
                        </div>
                        ` : ''}

                        ${soldInfo && !soldInfo.selling_available && !soldInfo.already_sold ? `
                        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #fbbf24; border-radius: 12px; padding: 15px 20px; margin: 10px 0;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: #92400e; margin-bottom: 5px;">
                                üóìÔ∏è SELLING AVAILABLE ON ${soldInfo.available_date}
                            </div>
                            <div style="font-size: 0.9rem; color: #92400e;">
                                ‚è∞ ${soldInfo.days_until_available} days remaining
                            </div>
                        </div>
                        ` : ''}

                        <!-- Score Stats -->
                        <div style="background: rgba(255, 255, 255, 0.2); border-radius: 18px; padding: 25px; margin: 20px 0; backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.3); position: relative; z-index: 1;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div>
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px;">Score</div>
                                    <div style="font-size: 2rem; font-weight: 800;">${score}/${total}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">${percentage}%</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px;">Earned</div>
                                    <div style="font-size: 2rem; font-weight: 800;">${reward} G$</div>
                                </div>
                            </div>
                        </div>

                        <!-- Platform Badge -->
                        <div style="margin-top: 20px; opacity: 0.95; font-size: 1.1rem; font-weight: 600; position: relative; z-index: 1;">
                            <div style="margin-bottom: 5px;">üåü GoodDollar Learn & Earn</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">Building Knowledge, Earning Rewards</div>
                        </div>
                    </div>

                    <!-- Share Description -->
                    <div id="share-description" style="padding: 25px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); text-align: center;">
                        <p style="margin: 0 0 15px 0; color: #495057; font-size: 1rem; font-weight: 600;">üì¢ Share Your Achievement!</p>
                        <p style="margin: 0 0 20px 0; color: #6c757d; font-size: 0.9rem; line-height: 1.6;">
                            üéì Just completed a GoodDollar Learn & Earn quiz!\n
                            üí∞ Score: ${score}/${total} | Earned: ${reward} G$\n
                            üöÄ Join me in earning crypto while learning!
                        </p>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button id="sell-btn-modal" ${soldInfo.already_sold || !soldInfo.selling_available ? 'disabled' : ''} style="padding: 12px 24px; background: ${soldInfo.already_sold || !soldInfo.selling_available ? '#ccc' : 'linear-gradient(135deg, #f59e0b, #d97706)'}; color: white; border: none; border-radius: 12px; font-weight: 700; cursor: ${soldInfo.already_sold || !soldInfo.selling_available ? 'not-allowed' : 'pointer'}; box-shadow: 0 4px 12px rgba(245,158,11,0.3);" title="${!soldInfo.selling_available && !soldInfo.already_sold ? `Available on ${soldInfo.available_date}` : ''}">
                                ${!soldInfo.selling_available && !soldInfo.already_sold ? 'üîí Locked Until ' + soldInfo.available_date : 'üí∞ Sell This Card'}
                            </button>
                            <button id="download-btn-modal" style="padding: 12px 24px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(40,167,69,0.3);">
                                üì• Download Card
                            </button>
                            <button id="twitter-btn-modal" style="padding: 12px 24px; background: linear-gradient(135deg, #1da1f2, #0d8bd9); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(29,161,242,0.3);">
                                üê¶ Share on Twitter
                            </button>
                            <button id="telegram-btn-modal" style="padding: 12px 24px; background: linear-gradient(135deg, #0088cc, #006699); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(0,136,204,0.3);">
                                üì± Share on Telegram
                            </button>
                        </div>
                        <button id="close-btn-modal" style="margin-top: 15px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 10px; cursor: pointer; width: 100%; font-weight: 600;">
                            ‚úï Close
                        </button>
                    </div>
                </div>
            `;

            // Attach event listeners after modal is rendered
            setTimeout(() => {
                const sellBtn = document.getElementById('sell-btn-modal');
                const downloadBtn = document.getElementById('download-btn-modal');
                const twitterBtn = document.getElementById('twitter-btn-modal');
                const telegramBtn = document.getElementById('telegram-btn-modal');
                const closeBtn = document.getElementById('close-btn-modal');

                if (sellBtn) {
                    sellBtn.onclick = function(e) {
                        e.preventDefault();
                        window.sellAchievementCard(score, total, reward, soldInfo);
                    };
                }
                if (downloadBtn) {
                    downloadBtn.onclick = function(e) {
                        e.preventDefault();
                        window.downloadAchievementCard();
                    };
                }
                if (twitterBtn) {
                    twitterBtn.onclick = function(e) {
                        e.preventDefault();
                        window.shareToTwitter(score, total, reward);
                    };
                }
                if (telegramBtn) {
                    telegramBtn.onclick = function(e) {
                        e.preventDefault();
                        window.shareToTelegram(score, total, reward);
                    };
                }
                if (closeBtn) {
                    closeBtn.onclick = function(e) {
                        e.preventDefault();
                        window.closeAchievementModal();
                    };
                }
            }, 100);
        }

        // Make functions globally accessible
        window.downloadAchievementCard = async function() {
            try {
                const card = document.getElementById('achievement-card');

                if (!card) {
                    showNotification('Achievement card not found', 'error');
                    return;
                }

                // Check if html2canvas is loaded
                if (typeof html2canvas === 'undefined') {
                    showNotification('Download library not loaded. Please refresh and try again.', 'error');
                    return;
                }

                showNotification('Generating image...', 'info');

                const canvas = await html2canvas(card, {
                    backgroundColor: null,
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                });

                // Convert to blob for better browser compatibility
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `gooddollar-achievement-${Date.now()}.png`;
                    link.href = url;
                    link.click();

                    // Clean up
                    setTimeout(() => URL.revokeObjectURL(url), 100);

                    showNotification('Achievement card downloaded! üì•', 'success');
                }, 'image/png');

            } catch (error) {
                console.error('Download error:', error);
                showNotification('Failed to download image: ' + error.message, 'error');
            }
        };

        window.shareToTwitter = function(score, total, reward) {
            const tweetText = `üéì Just achieved ${score}/${total} on GoodDollar Learn & Earn! Earned ${reward} G$! Join me and learn crypto. #GoodDollar #LearnAndEarn #Web3`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}&url=${encodeURIComponent(window.location.href)}`, '_blank');
        };

        window.shareToTelegram = function(score, total, reward) {
            const telegramText = `üéì Achievement Unlocked on GoodDollar Learn & Earn!\n\nScore: ${score}/${total}\nEarned: ${reward} G$\n\nJoin me in learning and earning crypto! üöÄ\n\n#GoodDollar #LearnAndEarn`;
            window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(telegramText)}`, '_blank');
        };

        window.closeAchievementModal = function() {
            const modal = document.getElementById('achievement-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.innerHTML = '';
            }
        };

        window.sellAchievementCard = async function(score, total, reward, soldInfo = {}) {
            try {
                // Calculate sell price based on score (max 1000 G$ for perfect score)
                const sellPrice = Math.round((score / total) * 1000);

                // Confirm with user
                if (!confirm(`Sell this achievement card for ${sellPrice} G$?`)) {
                    return;
                }

                showNotification('Processing card sale...', 'info');

                const response = await fetch('/learn-earn/sell-achievement-card', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        quiz_id: soldInfo.quiz_id,
                        score: score,
                        total_questions: total,
                        original_reward: reward,
                        sell_price: sellPrice,
                        quiz_timestamp: soldInfo.quiz_timestamp
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`Achievement card sold for ${sellPrice} G$! üéâ`, 'success');
                    window.closeAchievementModal();

                    // Refresh quiz history to update sold status
                    loadQuizHistory();
                } else {
                    // Check if selling is not yet available
                    if (!data.selling_available && data.available_date) {
                        const message = `üóìÔ∏è Achievement Card Selling\n\nSelling will be available on ${data.available_date}\n\n‚è∞ Days until available: ${data.days_until_available}\n\nSave your achievement cards and sell them when the feature becomes available!`;
                        alert(message);
                        showNotification(`Achievement card selling will be available on ${data.available_date}`, 'info');
                    } else {
                        showNotification(data.error || 'Failed to sell achievement card', 'error');
                    }
                }
            } catch (error) {
                console.error('Error selling achievement card:', error);
                showNotification('Failed to sell achievement card', 'error');
            }
        };


        // Reset quiz interface
        function resetQuiz() {
            // Clear any active timer
            if (questionTimer) {
                clearInterval(questionTimer);
            }

            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('start-quiz-btn').style.display = 'block';
            checkEligibility();
        }

        // Load quiz history
        async function loadQuizHistory() {
            try {
                const response = await fetch('/learn-earn/quiz-history?limit=10');
                const data = await response.json();

                console.log('üìä Quiz history response:', data);

                const historyTableBody = document.getElementById('history-table-body');
                const historyLoading = document.getElementById('history-loading');
                const historyContent = document.getElementById('history-content');

                if (data.success && data.quiz_history && data.quiz_history.length > 0) {
                    quizHistory = data.quiz_history; // Store history globally
                    historyTableBody.innerHTML = '';

                    data.quiz_history.forEach(quiz => {
                        const row = document.createElement('tr');
                        const date = new Date(quiz.timestamp).toLocaleDateString();
                        const txHash = quiz.transaction_hash || 'Pending';
                        const txLink = quiz.transaction_hash
                            ? `<a href="https://celoscan.io/tx/${quiz.transaction_hash}" target="_blank" class="tx-hash-link" title="View on Celoscan">
                                ${txHash.substring(0, 10)}...
                                <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i>
                            </a>`
                            : '<span style="color: #999; font-size: 0.9rem;">No TX</span>';

                        // Create achievement card link
                        const achievementLink = `
                            <a href="#" class="achievement-link" onclick="event.preventDefault(); window.showHistoryAchievement('${quiz.quiz_id}'); return false;" style="cursor: pointer; color: #667eea; text-decoration: none; font-weight: 600;">
                                üèÜ View Card
                            </a>
                        `;

                        row.innerHTML = `
                            <td>${date}</td>
                            <td>${quiz.score}/${quiz.total_questions}</td>
                            <td>${quiz.amount_g$} G$</td>
                            <td>${txLink}</td>
                            <td>${achievementLink}</td>
                        `;

                        historyTableBody.appendChild(row);
                    });
                } else {
                    historyTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No quiz history yet</td></tr>';
                }
                 historyLoading.style.display = 'none';
                 historyContent.style.display = 'block';
            } catch (error) {
                console.error('Error loading quiz history:', error);
                document.getElementById('history-loading').style.display = 'none';
                document.getElementById('history-content').style.display = 'block';
                document.getElementById('history-table-body').innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Failed to load history</td></tr>';
            }
        }

        // Show achievement card from history - make it globally accessible
        window.showHistoryAchievement = async function(quizId) {
            const quiz = quizHistory.find(q => q.quiz_id === quizId);
            if (!quiz) {
                console.error('Quiz not found:', quizId);
                return;
            }

            const score = quiz.score || 0;
            const total = quiz.total_questions || 0;
            const reward = quiz['amount_g$'] || 0;
            const quizTimestamp = quiz.timestamp;

            console.log(`üéØ Showing history achievement - Score: ${score}/${total}, Reward: ${reward}, Quiz ID: ${quizId}`);

            // Check if this card was already sold
            try {
                const checkResponse = await fetch('/learn-earn/check-card-sold', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        quiz_id: quizId,
                        score: score,
                        total_questions: total,
                        timestamp: quizTimestamp
                    })
                });

                const checkData = await checkResponse.json();

                if (checkData.success && checkData.already_sold) {
                    // Show card with "Already Sold" status
                    showAchievementCard(score, total, reward, {
                        already_sold: true,
                        sell_price: checkData.sell_price,
                        transaction_hash: checkData.transaction_hash,
                        sold_at: checkData.sold_at,
                        quiz_id: quizId,
                        quiz_timestamp: quizTimestamp,
                        selling_available: checkData.selling_available,
                        available_date: checkData.available_date,
                        days_until_available: checkData.days_until_available
                    });
                } else {
                    // Show normal card with sell option
                    showAchievementCard(score, total, reward, {
                        already_sold: false,
                        quiz_id: quizId,
                        quiz_timestamp: quizTimestamp,
                        selling_available: checkData.selling_available,
                        available_date: checkData.available_date,
                        days_until_available: checkData.days_until_available
                    });
                }
            } catch (error) {
                console.error('Error checking sold status:', error);
                // Show normal card on error - allow selling
                showAchievementCard(score, total, reward, {
                    already_sold: false,
                    quiz_id: quizId,
                    quiz_timestamp: quizTimestamp,
                    selling_available: false,
                    available_date: 'May 10, 2026',
                    days_until_available: 0
                });
            }
        };


        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.animation = 'none'; // Reset animation to ensure it shows

            // For temporary notifications, use a timeout to hide them
            const timeoutDuration = 5000; // 5 seconds
            setTimeout(() => {
                notification.style.animation = 'fadeOut 1s forwards';
                setTimeout(() => {
                    notification.style.display = 'none';
                    notification.style.animation = 'none'; // Reset for next time
                }, 1000); // Match fadeOut duration
            }, timeoutDuration);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await loadQuizSettings();
            checkEligibility();
            loadQuizHistory();

            // Add event listener to start quiz button
            const startQuizBtn = document.getElementById('start-quiz-btn');
            if (startQuizBtn) {
                startQuizBtn.addEventListener('click', startQuiz);
            }
        });
    </script>
</body>
</html>
